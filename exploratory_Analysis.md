

```sql
-- What is the total revenue generated by Olist, and how has it changed over time?

-- Total revenue of all time
SELECT ROUND(SUM(payment_value)) AS total_revenue
FROM order_payments op
JOIN orders o ON o.order_id = op.order_id
WHERE order_status <> 'canceled';

-- Yearly revenue trend
SELECT date_part('year', order_purchase_timestamp),
       SUM(payment_value) AS total_revenue
FROM orders AS o
INNER JOIN order_payments AS op ON o.order_id = op.order_id
WHERE order_status <> 'canceled'
GROUP BY 1
ORDER BY 1; -- The market was relatively new in 2016

-- Monthly revenue trend over the years
SELECT date_part('year', order_purchase_timestamp) AS year,
       date_part('month', order_purchase_timestamp) AS month,
       SUM(payment_value) AS total_revenue
FROM orders AS o
INNER JOIN order_payments AS op ON o.order_id = op.order_id
WHERE order_status <> 'canceled'
GROUP BY 1, 2
ORDER BY 1, 2;


-- How many orders were placed on Olist, and how does this vary by month or season?

-- Total orders placed
SELECT COUNT(*) AS num_of_orders
FROM orders;

-- Total orders placed per year
SELECT EXTRACT(YEAR FROM order_purchase_timestamp),
       COUNT(*) AS num_of_orders
FROM orders
GROUP BY 1
ORDER BY 1 DESC;

-- Total orders placed per month
SELECT to_char(order_purchase_timestamp, 'month') AS month,
       EXTRACT(YEAR FROM order_purchase_timestamp),
       COUNT(*) AS num_of_orders
FROM orders
GROUP BY 1, 2
ORDER BY 2 DESC, 3 DESC;

-- What are the most popular product categories on Olist, and how do their sales volumes compare to each other?

-- Sale volume by Count of total products sold per product_category
WITH pop_product_cat AS (
    SELECT product_category_name,
           COUNT(o.order_id) AS num_of_orders
    FROM products AS p
    JOIN order_items AS oi ON p.product_id = oi.product_id
    JOIN orders AS o ON oi.order_id = o.order_id
    GROUP BY 1
    ORDER BY 2 DESC
    LIMIT 10 -- Top 10 products by no. of orders
)
SELECT product_category_name_english AS product_category, num_of_orders
FROM pop_product_cat AS pc
JOIN product_category_name_translation AS pt ON pt.product_category_name = pc.product_category_name
ORDER BY 2 DESC;

-- Sales volume by Sum of total amount of product category
WITH sales_vol_by_product_cat AS (
    SELECT product_category_name,
           ROUND(SUM(payment_value)) AS total_sales
    FROM products
    JOIN order_items USING(product_id)
    JOIN order_payments USING(order_id)
    JOIN orders USING(order_id)
    WHERE order_status <> 'canceled'
    GROUP BY 1
    ORDER BY 2 DESC
    LIMIT 10 -- Top 10 products by revenue
)
SELECT product_category_name_english AS product_category, total_sales
FROM sales_vol_by_product_cat
JOIN product_category_name_translation USING(product_category_name)
ORDER BY 2 DESC;


-- What is the average order value (AOV) on Olist, and how does this vary by product category or payment method?

-- Overall average order value (AOV) on Olist
SELECT ROUND(SUM(payment_value)/COUNT(order_id)) AS avg_order_value
FROM order_payments;

-- Yearly average order value (AOV) on Olist
SELECT EXTRACT(YEAR FROM order_purchase_timestamp) AS year,
       ROUND(SUM(payment_value)/COUNT(order_id)) AS avg_order_value
FROM order_payments
JOIN orders USING(order_id)
GROUP BY 1; -- 2017 had the highest AOV compared with other years even though it had only 3 months of market

-- Avg order value by product category
SELECT product_category_name_english AS product_category, 
    ROUND(SUM(payment_value)/COUNT(op.order_id)) AS avg_order_value
FROM order_payments AS op
JOIN order_items AS oi ON op.order_id = oi.order_id
JOIN products AS p ON oi.product_id = p.product_id
JOIN product_category_name_translation AS pt ON pt.product_category_name = p.product_category_name
GROUP BY 1
ORDER BY 2
LIMIT 10;

-- Avg order value by payment method
SELECT payment_type AS payment_method,
    ROUND(SUM(payment_value)/COUNT(order_id)) AS avg_order_value
FROM order_payments
WHERE payment_type <> 'not_defined'
GROUP BY 1
ORDER BY 2;

-- How many sellers are active on Olist, and how does this number change over time?

-- Total number of sellers on Olist
SELECT COUNT(DISTINCT s.seller_id) AS seller_count
FROM sellers s
JOIN order_items oi ON s.seller_id = oi.seller_id
JOIN orders o ON o.order_id = oi.order_id
WHERE order_status <> 'canceled';

-- Number of active sellers on Olist in terms of recency
SELECT EXTRACT(YEAR FROM order_purchase_timestamp) AS year,
       COUNT(DISTINCT s.seller_id) AS num_of_active_sellers
FROM sellers s
JOIN order_items oi ON oi.seller_id = s.seller_id
JOIN orders o ON o.order_id = oi.order_id
JOIN products p ON p.product_id = oi.product_id
JOIN order_payments op ON op.order_id = o.order_id
WHERE order_status <> 'canceled'
GROUP BY 1
HAVING EXTRACT(MONTH FROM Age(MAX(order_purchase_timestamp), MIN(order_purchase_timestamp))) >= 3
ORDER BY 1;

-- Active sellers based on sales volume
SELECT COUNT(*)
FROM
    (SELECT seller_id, 
            SUM(payment_value) AS revenue
    FROM sellers
    JOIN order_items USING(seller_id)
    JOIN orders USING (order_id)
    JOIN order_payments USING (order_id)
    WHERE order_status <> 'canceled'
    GROUP BY 1
    ORDER BY 2 DESC) sub
WHERE revenue >= 6596; -- Avg revenue generated by sellers

-- Active sellers based on number of transactions
WITH seller_order_counts AS (
    SELECT s.seller_id AS id,
            COUNT(o.order_id) AS num_of_orders
    FROM sellers s
    JOIN order_items oi USING(seller_id)
    JOIN orders o USING(order_id)
    WHERE order_status <> 'canceled'
    GROUP BY 1
    ORDER BY 2 DESC
),
average_orders AS (
    SELECT ROUND(AVG(num_of_orders)) AS avg_orders
    FROM seller_order_counts
)
SELECT COUNT(id) AS num_of_active_sellers
FROM seller_order_counts
JOIN average_orders ON num_of_orders >= avg_orders;

-- What is the distribution of seller ratings on Olist, and how does this impact sales performance?
SELECT CASE 
        WHEN review_score = 1 THEN 'Very Dissatisfied'
        WHEN review_score = 2 THEN 'Dissatisfied'
        WHEN review_score = 3 THEN 'Neutral'
        WHEN review_score = 4 THEN 'Satisfied'
        WHEN review_score = 5 THEN 'Very Satisfied'
        ELSE 'N/A' END AS rating,
        COUNT(DISTINCT oi.seller_id) AS num_of_sellers,
        ROUND(SUM(price)) AS revenue,
        ROUND(SUM(price)*100 / SUM(SUM(price)) OVER()) AS percent_revenue,
        ROUND(COUNT(DISTINCT oi.seller_id)*100 / SUM(COUNT(DISTINCT oi.seller_id)) OVER()) AS percent_sellers
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
JOIN order_reviews r ON r.order_id = o.order_id
GROUP BY 1;

-- How many customers have made repeat purchases on Olist, and what percentage of total sales do they account for?

-- How many customers have made repeat purchases on Olist
SELECT COUNT(*) AS repeated_customers
FROM
    (SELECT customer_unique_id, COUNT(*) AS no_of_orders
    FROM customers c
    JOIN orders o ON c.customer_id = o.customer_id
    GROUP BY 1
    HAVING COUNT(DISTINCT order_id) > 1
    ORDER BY 2 DESC) sub;

-- Sales from repeat purchases
WITH t1 AS (
    SELECT SUM(payment_value) AS revenue
    FROM order_payments op
    JOIN orders o ON o.order_id = op.order_id
    JOIN customers c ON c.customer_id = o.customer_id
    WHERE customer_unique_id IN (  
        SELECT customer_unique_id
        FROM (
            SELECT customer_unique_id, COUNT(DISTINCT order_id) AS no_of_orders
            FROM customers c
            JOIN orders o ON c.customer_id = o.customer_id
            GROUP BY 1
            HAVING COUNT(DISTINCT order_id) > 1
            ORDER BY 2 DESC) sub)),
t2 AS (
    SELECT SUM(payment_value) AS revenue
    FROM order_payments op
    JOIN orders o ON op.order_id = o.order_id
)
SELECT ROUND((t1.revenue/t2.revenue)*100, 2) AS percent_sales
FROM t1
CROSS JOIN t2;


--overall average rating on olist products
SELECT ROUND(AVG(review_score)) AS avg_review_score
FROM order_reviews;

--sales performance with average customer rating per product
SELECT  product_category_name, ROUND(AVG(review_score)) AS avg_customer_rating, SUM(price) AS sales_sum
FROM products p
JOIN order_items oi
ON p.product_id = oi.product_id
JOIN order_reviews r
ON oi.order_id = r.order_id
GROUP BY 1
ORDER BY 2 DESC;

--What is the average order cancellation rate on Olist, and how does this impact seller performance?

SELECT
    order_status,
    COUNT(*) AS frequency_of_occurrence,
    ROUND((COUNT(*) * 100.0) / SUM(COUNT(*)) OVER (), 2) AS approved_percentage
FROM orders
GROUP BY order_status;

--What are the top-selling products on Olist, and how have their sales trends changed over time?
--top 20 selling products on olist
SELECT product_category_name_english AS product_category, SUM(payment_value) AS total_revenue, COUNT(o.order_id) AS total_unit_sold
FROM order_payments op
JOIN orders o 
ON o.order_id = op.order_id
JOIN order_items oi
ON op.order_id = oi.order_id
JOIN products p
ON p.product_id = oi.product_id
JOIN product_category_name_translation t
ON t.product_category_name = p.product_category_name
WHERE o.order_status <> 'canceled'
GROUP BY 1
ORDER BY 3 DESC, 2 DESC
LIMIT 20;

--2016 sales of products
DROP VIEW IF EXISTS sales_2016;
CREATE VIEW sales_2016 AS ( --This CTE calculates the total revenue for each product in 2016
								SELECT 
										t.product_category_name_english AS product, 
										SUM(op.payment_value) AS total_revenue_2016, 
										COUNT(oi.order_id) AS total_unit_sold_2016
								FROM order_payments op
								JOIN order_items oi ON op.order_id = oi.order_id
								JOIN orders o ON o.order_id = oi.order_id
								JOIN products p ON p.product_id = oi.product_id
								JOIN product_category_name_translation t ON t.product_category_name = p.product_category_name
								WHERE order_status <> 'canceled' AND EXTRACT(YEAR FROM o.order_approved_at) = '2016'
								GROUP BY 1
								ORDER BY 2 DESC)

--2017 sales of products
DROP VIEW IF EXISTS sales_2017;
CREATE VIEW sales_2017 AS ( --This CTE calculates the total revenue for each product in 2017
								SELECT 
										t.product_category_name_english AS product, 
										SUM(op.payment_value) AS total_revenue_2017, 
										COUNT(oi.order_id) AS total_unit_sold_2017
								FROM order_payments op
								JOIN order_items oi ON op.order_id = oi.order_id
								JOIN orders o ON o.order_id = oi.order_id
								JOIN products p ON p.product_id = oi.product_id
								JOIN product_category_name_translation t ON t.product_category_name = p.product_category_name
								WHERE order_status <> 'canceled' AND EXTRACT(YEAR FROM o.order_approved_at) = '2017'
								GROUP BY 1
								ORDER BY 2 DESC)

--2018 sales of products
DROP VIEW IF EXISTS sales_2018;
CREATE VIEW sales_2018 AS ( --This CTE calculates the total revenue for each product in 2018
								SELECT 
										t.product_category_name_english AS product, 
										SUM(op.payment_value) AS total_revenue_2018, 
										COUNT(oi.order_id) AS total_unit_sold_2018
								FROM order_payments op
								JOIN order_items oi ON op.order_id = oi.order_id
								JOIN orders o ON o.order_id = oi.order_id
								JOIN products p ON p.product_id = oi.product_id
								JOIN product_category_name_translation t ON t.product_category_name = p.product_category_name
								WHERE order_status <> 'canceled' AND EXTRACT(YEAR FROM o.order_approved_at) = '2018'
								GROUP BY 1
								ORDER BY 2 DESC)
--This query computes the revenue made by all products in the market for each year
SELECT product, total_revenue_2016, total_revenue_2017, total_revenue_2018
FROM sales_2016
RIGHT JOIN sales_2017 USING (product)
LEFT JOIN sales_2018 USING (product);

-- Which payment methods are most commonly used by Olist customers, and how does this vary by product category or geographic region?
--Payment methods and its freuency 
SELECT payment_type AS payment_method, COUNT(*)
FROM order_payments
GROUP BY 1
ORDER BY 1;

-- credit card
SELECT t.product_category_name_english AS product, COUNT(op.payment_type) no_of_credit_card
FROM order_payments op
JOIN order_items oi ON op.order_id = oi.order_id
JOIN products p ON p.product_id = oi.product_id
JOIN product_category_name_translation t ON t.product_category_name = p.product_category_name
WHERE op.payment_type = 'credit_card'
GROUP BY 1
ORDER BY 2 DESC;

--voucher
SELECT t.product_category_name_english AS product, COUNT(op.payment_type) no_of_voucher
FROM order_payments op
JOIN order_items oi ON op.order_id = oi.order_id
JOIN products p ON p.product_id = oi.product_id
JOIN product_category_name_translation t ON t.product_category_name = p.product_category_name
WHERE op.payment_type = 'voucher'
GROUP BY 1
ORDER BY 2 DESC;

-- Boleto
SELECT t.product_category_name_english AS product, COUNT(op.payment_type) no_of_boleto
FROM order_payments op
JOIN order_items oi ON op.order_id = oi.order_id
JOIN products p ON p.product_id = oi.product_id
JOIN product_category_name_translation t ON t.product_category_name = p.product_category_name
WHERE op.payment_type = 'boleto'
GROUP BY 1
ORDER BY 2 DESC;

-- Debit card
SELECT t.product_category_name_english AS product, COUNT(op.payment_type) AS no_of_debit_card
FROM order_payments op
JOIN order_items oi ON op.order_id = oi.order_id
JOIN products p ON p.product_id = oi.product_id
JOIN product_category_name_translation t ON t.product_category_name = p.product_category_name
WHERE op.payment_type = 'debit_card'
GROUP BY 1
ORDER BY 2 DESC;

-- Variation of payment method by geolocation (Credit card)
SELECT customer_state as location, COUNT(op.payment_type) AS no_of_credit_cards
FROM order_payments op
JOIN orders o ON op.order_id = o.order_id
JOIN customers c ON c.customer_id = o.customer_id
WHERE op.payment_type = 'credit_card'
GROUP BY 1
ORDER BY 2 DESC;

-- Variation of payment method by geolocation (Voucher)
SELECT customer_state as location, COUNT(op.payment_type) AS no_of_voucher
FROM order_payments op
JOIN orders o ON op.order_id = o.order_id
JOIN customers c ON c.customer_id = o.customer_id
WHERE op.payment_type = 'voucher'
GROUP BY 1
ORDER BY 2 DESC;

-- Variation of payment method by geolocation (Boleto)
SELECT customer_state as location, COUNT(op.payment_type) AS no_of_boleto
FROM order_payments op
JOIN orders o ON op.order_id = o.order_id
JOIN customers c ON c.customer_id = o.customer_id
WHERE op.payment_type = 'boleto'
GROUP BY 1
ORDER BY 2 DESC;

-- Variation of payment method by geolocation (Debit card)
SELECT customer_state as location, COUNT(op.payment_type) AS no_of_debit_cards
FROM order_payments op
JOIN orders o ON op.order_id = o.order_id
JOIN customers c ON c.customer_id = o.customer_id
WHERE op.payment_type = 'debit_card'
GROUP BY 1
ORDER BY 2 DESC;

-- Which product categories have the highest profit margins on Olist, and how can the company increase profitability across different categories?
-- Profit margins
SELECT product_category_name_english AS product,
       ROUND((SUM(payment_value) - (SUM(price) + SUM(freight_value)))*100 / SUM(payment_value), 2) AS profit_margins
FROM order_items oi
JOIN order_payments op ON oi.order_id = op.order_id
JOIN products p ON p.product_id = oi.product_id
JOIN product_category_name_translation t ON t.product_category_name = p.product_category_name 
GROUP BY 1
ORDER BY 2 DESC;

-- How does Olist's marketing spend and channel mix impact sales and customer acquisition costs, and how can the company optimize its marketing strategy to increase ROI?
SELECT customer_state AS location, COUNT(DISTINCT customer_unique_id) AS no_of_customers
FROM customers
GROUP BY 1
ORDER BY 2 DESC;

WITH retained AS (
                    SELECT customer_state, COUNT(customer_unique_id) AS customers_retained
                    FROM customers
                    WHERE customer_unique_id IN (
                        SELECT customer_unique_id
                        FROM (
                            SELECT customer_unique_id, COUNT(*)
                            FROM customers c
                            JOIN orders o ON c.customer_id = o.customer_id
                            GROUP BY 1
                            HAVING COUNT(order_id) >= 2) sub)
                    GROUP BY 1
                ),
    
        total AS (
                    SELECT customer_state, COUNT(customer_unique_id) AS no_of_customers
                    FROM customers
                    GROUP BY 1
                    ORDER BY 2 DESC 
                 )
    
SELECT total.customer_state AS location, ROUND((customers_retained::numeric / no_of_customers::numeric) * 100) AS retention_rate
FROM retained
JOIN total ON retained.customer_state = total.customer_state
ORDER BY 2 DESC;

```olocation_state
    END;
```
